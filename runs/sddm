#!/usr/bin/env bash

log() {
    echo "[SDDM] $1"
}

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
SDDM_CONFIG="$REPO_ROOT/files/sddm/config/sddm.conf"
SDDM_THEMES="$REPO_ROOT/files/sddm/themes"
SYSTEM_SDDM="/etc/sddm.conf"
SYSTEM_THEMES="/usr/share/sddm/themes"

log "Configuring SDDM display manager..."

# Check if SDDM config exists in repo
if [[ ! -f "$SDDM_CONFIG" ]]; then
    log "ERROR: SDDM config not found at $SDDM_CONFIG"
    exit 1
fi

# Backup existing SDDM config if it exists
if [[ -f "$SYSTEM_SDDM" && ! -L "$SYSTEM_SDDM" ]]; then
    log "Backing up existing SDDM config to ${SYSTEM_SDDM}.backup"
    sudo cp "$SYSTEM_SDDM" "${SYSTEM_SDDM}.backup"
fi

# Remove existing config if it's a regular file
if [[ -f "$SYSTEM_SDDM" && ! -L "$SYSTEM_SDDM" ]]; then
    sudo rm "$SYSTEM_SDDM"
fi

# Create symlink to our config
log "Creating symlink from $SYSTEM_SDDM to $SDDM_CONFIG"
sudo ln -sf "$SDDM_CONFIG" "$SYSTEM_SDDM"

# Install custom themes if they exist
if [[ -d "$SDDM_THEMES" ]]; then
    for theme in "$SDDM_THEMES"/*; do
        if [[ -d "$theme" ]]; then
            theme_name="$(basename "$theme")"
            
            # Skip empty directories or directories named 'custom'
            if [[ "$theme_name" == "custom" ]] || [[ ! "$(ls -A "$theme" 2>/dev/null)" ]]; then
                log "Skipping empty/placeholder directory: $theme_name"
                continue
            fi
            
            target="$SYSTEM_THEMES/$theme_name"
            
            # Remove existing theme if it exists
            if [[ -e "$target" ]]; then
                log "Removing existing theme: $theme_name"
                sudo rm -rf "$target"
            fi
            
            log "Installing theme: $theme_name"
            sudo cp -r "$theme" "$SYSTEM_THEMES/"
        fi
    done
fi

# Restart SDDM to apply changes
log "Restarting SDDM service..."
sudo systemctl restart sddm

log "SDDM configuration completed!"
log "Key changes:"
log "  - Applied custom SDDM configuration"
log "  - Installed custom themes (if any)"
log "  - Backup created at ${SYSTEM_SDDM}.backup"
log ""
log "Log out or reboot to see the login screen changes."