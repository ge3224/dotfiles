#!/usr/bin/env bash

# Tmux Configuration Run
# Installs tmux if not present and symlinks custom tmux.conf file

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"

echo "Setting up tmux configuration..."

# Check if tmux is installed
if ! command -v tmux &> /dev/null; then
    echo "tmux not found. Installing tmux..."
    
    # Detect package manager and install tmux
    if command -v pacman &> /dev/null; then
        sudo pacman -S --noconfirm tmux
    elif command -v apt &> /dev/null; then
        sudo apt update && sudo apt install -y tmux
    elif command -v dnf &> /dev/null; then
        sudo dnf install -y tmux
    elif command -v brew &> /dev/null; then
        brew install tmux
    else
        echo "Error: Could not detect package manager. Please install tmux manually."
        exit 1
    fi
    
    echo "tmux installed successfully!"
else
    echo "tmux is already installed"
fi

# Backup existing tmux.conf if it exists and isn't a symlink
if [ -f "$HOME/.tmux.conf" ] && [ ! -L "$HOME/.tmux.conf" ]; then
    echo "Backing up existing .tmux.conf to .tmux.conf.backup"
    cp "$HOME/.tmux.conf" "$HOME/.tmux.conf.backup"
fi

# Create symlink from dotfiles
echo "Creating symlink to tmux.conf"
ln -sf "$DOTFILES_DIR/files/tmux/tmux.conf" "$HOME/.tmux.conf"

echo "Tmux configuration installed successfully!"
echo "Start a new tmux session with 'tmux' to use the new configuration."